#!/bin/bash

BASEDIR=/sys/devices/system/cpu/cpufreq

if [[ ! -d "${BASEDIR}" ]]; then
    echo "no frequency scaling support detected"
fi

if [[ $# -ge 1 ]]; then
    case "${1}" in
        "-h"|"--help")
            cat <<EOF
Usage

Options:
-h | --help     This help

Commands:
list            Show the currently active governors
EOF
            exit 0
            ;;
        "list")
            for d in "${BASEDIR}"/policy?; do
                cat "${d}/scaling_governor"
            done
            exit 0
            ;;
        *)
            echo "unknown command line option"
            exit 1
            ;;
    esac
fi

# Figure out what governor is currently being used.
echo "checking power supply status"
for d in $(find /sys/devices -type d -name 'power_supply'); do
    if [[ -r "${d}"/AC/online ]]; then
        read -r ac_online < "${d}"/AC/online
    fi
done
if [[ ${ac_online} == "1" ]]; then
    echo "AC power connected"
    wanted_governor=conservative
    wanted_cpus=all
elif [[ ${ac_online} == "0" ]]; then
    echo "AC power disconnected"
    wanted_governor=powersave
    wanted_cpus=1
else
    echo "can not find power information"
    exit 0
fi

# Check into the battery.
echo "checking batter levels"
energy_full_design="unknown"
energy_full="unknown"
energy_now="unknown"
for d in $(find /sys/devices -type d -iname '*bat*'); do
    if [[ -r "${d}"/energy_full_design ]]; then
        read -r energy_full_design < "${d}"/energy_full_design
    fi
    if [[ -r "${d}"/energy_full ]]; then
        read -r energy_full < "${d}"/energy_full
    fi
    if [[ -r "${d}"/energy_now ]]; then
        read -r energy_now < "${d}"/energy_now
    fi
done
if [[ ${energy_now} != "unknown" ]]; then
    echo "energy_now         = ${energy_now}"
fi
if [[ ${energy_full} != "unknown" ]]; then
    echo "energy_full        = ${energy_full}"
fi
if [[ ${energy_full_design} != "unknown" ]]; then
    echo "energy_full_design = ${energy_full_design}"
    battery_health=$(( 100 * ${energy_full} / ${energy_full_design} ))
    echo "battery health     = ${battery_health}%"
fi

if [[ "${wanted_cpus}" == "all" ]]; then
    for c in /sys/devices/system/cpu/cpu?/online; do
        echo "1" > "${c}"
    done
else
    cpu_online=0
    for c in /sys/devices/system/cpu/cpu?/online; do
        echo "checking cpu at ${c}"
        if [[ ${cpu_online} -lt ${wanted_cpus} || ${wanted_cpus} = "all" ]]; then
            echo "turning on cpu${cpu_online}"
            echo "1" > "${c}"
        else
            echo "turning off cpu${cpu_online}"
            echo "0" > "${c}"
        fi
        cpu_online=$(( ${cpu_online} + 1 ))
    done
fi

echo "checking scaling governors"
for d in "${BASEDIR}"/policy?; do
    if [[ -r "${d}"/scaling_governor ]]; then
        read -r governor < "${d}"/scaling_governor
    else
        echo "can not read current scaling governor"
        break
    fi
    if [[ -w "${d}"/scaling_governor ]]; then
        if [[ "${governor}" != "${wanted_governor}" ]]; then
            echo "updating ${governor} to ${wanted_governor}"
            echo "${wanted_governor}" > "${d}"/scaling_governor
        else
            echo "governor already correctly set to ${governor}"
        fi
    else
        echo "can not set scaling governor"
        break
    fi
done
